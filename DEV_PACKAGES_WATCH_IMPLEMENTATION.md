# Package Watching in Dev Mode - Implementation Summary

## Overview

This document summarizes the implementation of package watching functionality for `yarn cedar dev`, enabling hot-reloading of workspace packages during development.

## What Was Implemented

### 1. Watch Packages Task (`watchPackagesTask.js`)

**File:** `cedar/packages/cli/src/commands/dev/watchPackagesTask.js`

A new module that:
- Accepts package workspace names (e.g., `['packages/*']`, `['@org/pkg-one', 'pkg-two']`)
- Maps workspace names to filesystem paths using glob patterns
- Filters packages to only include those with a `watch` script
- Warns users about packages without watch scripts
- Uses `concurrently` to run `yarn watch` in each package directory in parallel
- Returns `null` if no watchable packages are found
- Handles errors with proper telemetry

**Key Features:**
- Supports both wildcard (`packages/*`) and specific package names
- Graceful degradation when packages lack watch scripts
- Proper error handling and user feedback

### 2. Dev Command Definition Updates (`dev.ts`)

**File:** `cedar/packages/cli/src/commands/dev.ts`

Updated the command definition to:
- Remove strict `choices` restriction on the `side` positional argument
- Accept package workspace names in addition to 'api' and 'web'
- Update description to document valid values
- Add `.check()` validation similar to the `build` command
- Validate that requested workspaces exist using `workspaces({ includePackages: true })`
- Provide clear error messages for unknown workspaces

**Key Features:**
- Validates workspace names against actual project structure
- Optimizes by only calling `workspaces()` when non-standard sides are specified
- Maintains backward compatibility with existing usage

### 3. Dev Handler Updates (`devHandler.ts`)

**File:** `cedar/packages/cli/src/commands/devHandler.ts`

Enhanced the dev handler to:
- Import `watchPackagesTask` and `buildPackagesTask`
- Extract package workspaces from the `side` array
- Check if package workspaces exist in root `package.json`
- Perform initial build of packages before starting watchers
- Add a 'packages' job to the concurrent jobs object
- Configure the job to run by default when packages exist (Option A)
- Handle async command execution properly
- Use 'yellow' as the prefix color for package output

**Key Features:**
- Initial build ensures packages are compiled before watchers start
- Graceful error handling - warnings instead of failures on initial build errors
- Automatic detection and watching of packages when they exist
- Clean integration with existing api/web/gen jobs

## How It Works

### Default Behavior

When running `yarn cedar dev`:

1. **Detection:** The handler checks if workspace packages exist by:
   - Reading root `package.json`
   - Checking if `workspaces` array has more than 2 entries (beyond api/web)
   - Checking if the `packages/` directory exists

2. **Initial Build:** If packages exist:
   - Runs `buildPackagesTask` to compile all packages once
   - Logs warnings if build fails (doesn't abort - watchers will rebuild)

3. **Watch Mode:** If packages exist and have watch scripts:
   - Spawns `yarn watch` process for each package
   - Runs concurrently with api, web, and gen watchers
   - Each package watcher is labeled with the package name
   - Uses yellow color prefix for visibility

### Explicit Usage

Users can explicitly control which workspaces to run:

```bash
# Run everything (default includes packages if they exist)
yarn cedar dev

# Run only api and web (no packages)
yarn cedar dev api web

# Run everything including packages explicitly
yarn cedar dev api web packages/*

# Run specific packages only
yarn cedar dev my-package

# Run api with specific packages
yarn cedar dev api packages/my-package @org/another-package
```

## Package Requirements

For a package to be watched, it must:
1. Exist in the `packages/` directory
2. Have a valid `package.json` file
3. Have a `watch` script defined (typically `"watch": "tsc --watch"`)

Packages generated by `yarn cedar generate package` automatically include the watch script.

## Error Handling

The implementation handles several edge cases:

- **No packages directory:** Silently skips package watching
- **No watchable packages:** Returns early, no error
- **Package without watch script:** Logs warning, skips that package
- **Initial build failure:** Logs warning, continues with watchers
- **Unknown workspace name:** Validation error before starting
- **Watch process error:** Proper telemetry and error reporting

## Architecture Decisions

### Why Option A (Watch by Default)?

Packages are watched automatically when they exist because:
- Matches user expectations (similar to api/web)
- Provides the best developer experience
- Packages are shared code - usually need to be rebuilt frequently
- Easy to opt-out by explicitly specifying sides

### Why Initial Build?

An initial build ensures:
- Packages are compiled before api/web try to import them
- Faster first load (watchers start from a clean state)
- Clear feedback if there are compilation errors

### Why Concurrently?

Using `concurrently` maintains consistency with existing architecture:
- Same pattern as api/web/gen jobs
- Individual process management per package
- Clear, labeled console output
- Proven reliability

## Testing Checklist

- [ ] Test `yarn cedar dev` with no packages directory
- [ ] Test `yarn cedar dev` with empty packages directory
- [ ] Test `yarn cedar dev` with one package
- [ ] Test `yarn cedar dev` with multiple packages
- [ ] Test `yarn cedar dev api web` (explicitly excluding packages)
- [ ] Test `yarn cedar dev packages/*` (explicitly including all packages)
- [ ] Test `yarn cedar dev <specific-package-name>`
- [ ] Test package without watch script (should skip with warning)
- [ ] Verify changes in packages trigger TypeScript recompilation
- [ ] Verify concurrent output displays correctly with package prefix
- [ ] Verify error handling when package doesn't exist

## Files Changed

### New Files
- `cedar/packages/cli/src/commands/dev/watchPackagesTask.js` (88 lines)

### Modified Files
- `cedar/packages/cli/src/commands/dev.ts` (+38 lines)
- `cedar/packages/cli/src/commands/devHandler.ts` (+47 lines)

## Next Steps

1. **Manual Testing:** Test all scenarios in the testing checklist
2. **Documentation:** Update CLI documentation (held for later)
3. **E2E Tests:** Add automated tests for package watching
4. **Performance:** Monitor performance with many packages

## Notes

- No feature flag required - feature is always available
- No breaking changes to existing behavior
- Backward compatible with projects without packages
- Follows established patterns from `build` command